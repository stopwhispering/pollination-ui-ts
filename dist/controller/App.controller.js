sap.ui.define(["sap/m/MessageBox","sap/ui/model/json/JSONModel","sap/ui/Device","./BaseController","sap/m/MessageToast","sap/ui/model/FilterOperator","sap/ui/model/Filter","sap/ui/core/Fragment","sap/m/Dialog","sap/m/ColorPalettePopover","../model/formatter","sap/m/Button","sap/m/library","sap/ui/core/library","sap/m/Text"],function(e,n,t,o,i,l,a,s,r,c,d,_,p,g,f){function u(e){return e&&e.__esModule&&typeof e.default!=="undefined"?e.default:e}const h=t["browser"];const w=u(o);const P=u(d);const m=p["ButtonType"];const v=p["DialogType"];const M=g["ValueState"];const C=w.extend("pollination.ui.controller.App",{constructor:function e(){w.prototype.constructor.apply(this,arguments);this.formatter=new P},onInit:function e(){this.getView().setModel(new n({isMobile:h.mobile}),"view");this._load_initial_data();this._new_temp_pollination={pollinationTimestamp:this.format_timestamp(new Date),location:"indoor_led"};var t=new n(this._new_temp_pollination);this.getView().setModel(t,"newTempPollinationModel");this._reset_temp_pollination_florescence();this._reset_temp_pollination_pollen();this._new_pollinations=[];var t=new n(this._new_pollinations);this.getView().setModel(t,"newPollinationsModel")},_reset_temp_pollination_florescence:function e(){this._new_temp_pollination.florescenceId=undefined;this._new_temp_pollination.florescencePlantName=undefined;this._new_temp_pollination.florescencePlantId=undefined;this._new_temp_pollination.florescenceStatus=undefined;this._new_temp_pollination.availableColorsRgb=["transparent","black"];this._new_temp_pollination.labelColorRgb="transparent";this.getView().getModel("newTempPollinationModel").updateBindings(false)},_reset_temp_pollination_pollen:function e(){this._new_temp_pollination.pollenDonorPlantName=undefined;this._new_temp_pollination.pollenDonorPlantId=undefined;this._new_temp_pollination.pollenType=undefined;this.getView().getModel("newTempPollinationModel").updateBindings(false)},_load_initial_data:function e(){this._load_settings();this._load_active_florescences();this._load_ongoing_pollinations()},_load_settings:function e(){$.ajax({url:this.getServiceUrl("pollinations/settings"),data:{},context:this,async:true}).done(this._onDoneLoadSettings).fail(this.onFail.bind(this,"Load settings"))},_onDoneLoadSettings:function e(t){var o=new n(t);this.getView().setModel(o,"settingsModel")},_load_active_florescences:function e(){$.ajax({url:this.getServiceUrl("active_florescences"),data:{},context:this,async:true}).done(this._onDoneLoadActiveInflorescences).fail(this.onFail.bind(this,"Load current florescences"))},_onDoneLoadActiveInflorescences:function e(t){var o=new n(t.activeFlorescenceCollection);this.getView().setModel(o,"currentFlorescencesModel");this._reset_temp_pollination_florescence()},_load_ongoing_pollinations:function e(){$.ajax({url:this.getServiceUrl("ongoing_pollinations"),data:{},context:this,async:true}).done(this._onDoneLoadOngoingPollinations).fail(this.onFail.bind(this,"Load ongoing pollinations"))},_onDoneLoadOngoingPollinations:function e(t){var o=this.getView().getModel("ongoingPollinationsModel");if(!o){var o=new n(t.ongoingPollinationCollection);this.getView().setModel(o,"ongoingPollinationsModel")}else{o.setData(t.ongoingPollinationCollection)}},onSelectionChangedCurrentFlorescence:function e(n){var t=n.getParameter("listItem").getBindingContext("currentFlorescencesModel").getObject();$.ajax({url:this.getServiceUrl("potential_pollen_donors/"+t.id),data:{},context:this,async:true}).done(this._onDoneLoadPotentialPollenDonors).fail(this.onFail.bind(this,"Load potential pollen donors"));this._new_temp_pollination.florescencePlantName=t.plant_name;this._new_temp_pollination.florescencePlantId=t.plant_id;this._new_temp_pollination.florescenceId=t.id;this._new_temp_pollination.florescenceStatus=t.florescence_status;this._new_temp_pollination.availableColorsRgb=this._getAvailableColors(t);this.getView().getModel("newTempPollinationModel").updateBindings(false)},_getAvailableColors:function e(n){var t=JSON.parse(JSON.stringify(n.available_colors_rgb));for(var o=0;o<this._new_pollinations.length;o++){var i=this._new_pollinations[o];if(this._new_temp_pollination.florescenceId===i.florescenceId){var l=t.indexOf(i.labelColorRgb);if(l>=0){t.splice(l,1)}}}return t},onSelectionChangedPollenDonor:function e(n){var t=n.getParameter("listItem").getBindingContext("potentialPollenDonorsModel").getObject();this._new_temp_pollination.pollenDonorPlantName=t.plant_name;this._new_temp_pollination.pollenDonorPlantId=t.plant_id;this._new_temp_pollination.pollenType=t.pollen_type;var o=this.getView().getModel("newTempPollinationModel");o.updateBindings(false)},_onDoneLoadPotentialPollenDonors:function e(t){var o=new n(t.potentialPollenDonorCollection);this.getView().setModel(o,"potentialPollenDonorsModel");this._reset_temp_pollination_pollen()},getPollenTypeGroup:function e(n){const t=n.getProperty("pollen_type")+" Pollen";return t.toUpperCase().replace("_"," ")},getFlorescenceStatusGroup:function e(n){return n.getProperty("florescence_status").toUpperCase().replace("_"," ")},getPollinationStatusGroup:function e(n){return n.getProperty("pollination_status").toUpperCase().replace("_"," ")},getPollinationStatusComparator:function e(n,t){const o={ATTEMPT:1,SEED_CAPSULE:2,GERMINATED:3};const i=o[n];const l=o[t];if(i<l){return-1}else{return 1}},getGenusGroup:function e(n){return n.getProperty("genus")},onColorSelect:function e(n){this._new_temp_pollination.labelColorRgb=n.getParameter("value");var t=this.getView().getModel("newTempPollinationModel");t.updateBindings(false)},onPressAddButton:function e(n){var t=this.getView().byId("activeFlorescencesList").getSelectedItem();if(t===null||t===undefined){i.show("Please select a florescence.");return}var o=t.getBindingContext("currentFlorescencesModel").getObject();var l=this.getView().byId("potentialPollenDonorsList").getSelectedItem();var a=l.getBindingContext("potentialPollenDonorsModel").getObject();if(this._new_temp_pollination.florescencePlantName!==o.plant_name||this._new_temp_pollination.pollenDonorPlantName!==a.plant_name){i.show("Bad Plant Names.");return}switch(this._new_temp_pollination.location){case"indoor_led":var s="indoor LED";break;case"indoor":var s="indoor";break;case"outdoor":var s="outdoor";break;default:i.show("Bad Location.");return}if(!this._new_temp_pollination.labelColorRgb||this._new_temp_pollination.labelColorRgb===""||this._new_temp_pollination.labelColorRgb==="transparent"){i.show("Choose Color first.");return}var r={florescenceId:this._new_temp_pollination.florescenceId,seedCapsulePlantName:o.plant_name,seedCapsulePlantId:o.plant_id,pollenDonorPlantName:a.plant_name,pollenDonorPlantId:a.plant_id,pollenType:this._new_temp_pollination.pollenType,pollinationTimestamp:this._new_temp_pollination.pollinationTimestamp,location:this._new_temp_pollination.location,locationText:s,labelColorRgb:this._new_temp_pollination.labelColorRgb};this._new_pollinations.push(r);this.getView().getModel("newPollinationsModel").updateBindings(false);this._new_temp_pollination.labelColorRgb="transparent";this._new_temp_pollination.availableColorsRgb=this._getAvailableColors(o);this.getView().getModel("newTempPollinationModel").updateBindings(false)},_deleteNewPollination:function e(n){var t=this._new_pollinations.indexOf(n);this._new_pollinations.splice(t,1);this.getView().getModel("newPollinationsModel").updateBindings(false)},onPressDeleteNewPollinationButton:function e(n){var t=n.getSource().getBindingContext("newPollinationsModel").getObject();this._deleteNewPollination(t)},onPressSaveNewPollinationButton:function e(n){var t=n.getSource().getBindingContext("newPollinationsModel").getObject();var o=JSON.stringify(t);$.ajax({url:this.getServiceUrl("pollinations"),data:o,context:this,async:true,type:"POST",contentType:"application/json"}).done(this._onDonePostNewPollination.bind(this,t)).fail(this.onFail.bind(this,"Save new pollinations"))},_onDonePostNewPollination:function e(n){this._load_ongoing_pollinations();this._load_active_florescences();this.getView().getModel("newPollinationsModel");this._deleteNewPollination(n)},onLiveChangeOngoingPollinationsFilter:function e(n){var t=[];var o=n.getSource().getValue();if(o&&o.length>0){var i=new a([new a("seed_capsule_plant_name",l.Contains,o),new a("pollen_donor_plant_name",l.Contains,o),new a("seed_capsule_plant_id",l.EQ,o),new a("pollen_donor_plant_id",l.EQ,o),new a("pollination_timestamp",l.Contains,o),new a("pollen_type",l.Contains,o)],false);t.push(i)}var s=this.byId("ongoingPollinationsList");var r=s.getBinding("items");r.filter(t,"Application")},onPressEditActiveFlorescence:function e(t){var o=t.getSource().getBindingContext("currentFlorescencesModel").getObject();var i=JSON.parse(JSON.stringify(o));i.flowers_count_known=!!i.flowers_count;i.branches_count_known=!!i.branches_count;i.inflorescence_appearance_date_known=!!i.inflorescence_appearance_date;i.first_flower_opening_date_known=!!i.first_flower_opening_date;i.last_flower_closing_date_known=!!i.last_flower_closing_date;var l=this.getView();var a=e=>{l.addDependent(e);var t=new n(i);l.setModel(t,"editedFlorescenceModel");e.open()};if(!this.byId("editedFlorescenceModel")){s.load({name:"pollination.ui.view.fragments.EditFlorescence",id:l.getId(),controller:this}).then(a)}else{a(this.byId("editedFlorescenceModel"))}},onAfterCloseEditFlorescenceDialog:function e(n){var t=n.getSource();t.destroy();this.getView().getModel("editedFlorescenceModel").destroy()},onPressEditFlorescenceSetToday:function e(n){var t=this.getView().getModel("editedFlorescenceModel");var o=t.getData();o[n]=(new Date).toISOString().substring(0,10);t.updateBindings(false)},onPressSubmitEditFlorescence:function e(n){var t=this.getView().getModel("editedFlorescenceModel");var o=t.getData();if(!o.branches_count_known){o.branches_count=undefined}if(!o.flowers_count_known){o.flowers_count=undefined}if(!o.inflorescence_appearance_date_known){o.inflorescence_appearance_date=undefined}if(!o.first_flower_opening_date_known){o.first_flower_opening_date=undefined}if(!o.last_flower_closing_date_known){o.last_flower_closing_date=undefined}if(o.florescence_status==="inflorescence_appeared"){o.first_flower_opening_date=undefined;o.last_flower_closing_date=undefined}else if(o.florescence_status==="flowering"){o.last_flower_closing_date=undefined}else if(o.florescence_status==="finished"){}else{throw new Error("Unknown florescence status: "+o.florescence_status)}var i=JSON.stringify(o);$.ajax({url:this.getServiceUrl("active_florescences/"+o.id),data:i,context:this,async:true,type:"PUT",contentType:"application/json"}).done(this._onDonePutFlorescence).fail(this.onFail.bind(this,"Update florescence"))},_onDonePutFlorescence:function e(){this.applyToFragment("editFlorescence",e=>{e.close()});this._load_active_florescences()},onPressDeleteFlorescence:function n(t){var o=this.getView().getModel("editedFlorescenceModel").getData().id;e.confirm("Really delete Florescence? This cannot be undone.",{onClose:this._onConfirmDeleteFlorescence.bind(this,o)})},_onConfirmDeleteFlorescence:function e(n,t){if(t==="OK"){this._deleteFlorescence(n)}else{}},_deleteFlorescence:function e(n){$.ajax({url:this.getServiceUrl("florescences/"+n),context:this,async:true,type:"DELETE",contentType:"application/json"}).done(this._onDoneDeleteFlorescence).fail(this.onFail.bind(this,"Delete florescences"))},_onDoneDeleteFlorescence:function e(){this.applyToFragment("editFlorescence",e=>{e.close()});this._load_active_florescences()},onPressEditOngoingPollination:function e(t){var o=t.getSource().getBindingContext("ongoingPollinationsModel").getObject();var i=JSON.parse(JSON.stringify(o));i.pollination_timestamp_known=!!i.pollination_timestamp;i.harvest_date_known=!!i.harvest_date;var l=this.getView();var a=e=>{l.addDependent(e);var t=new n(i);l.setModel(t,"editedPollinationModel");e.open()};if(!this.byId("editPollination")){s.load({name:"pollination.ui.view.fragments.EditPollination",id:this.getView().getId(),controller:this}).then(a)}else{a(this.byId("editPollination"))}},onAfterCloseEditPollinationDialog:function e(n){var t=n.getSource();t.destroy();this.getView().getModel("editedPollinationModel").destroy()},onOpenColorPalettePopover:function e(n){const t=n.getSource();var o=this.getView().getModel("settingsModel");var i=o.getProperty("/colors");if(!this._oColorPalettePopoverMinDefautButton){this._oColorPalettePopoverMinDefautButton=new c("oColorPalettePopoverMinDef",{showMoreColorsButton:false,colors:i,colorSelect:this._onSelectColorInColorPalettePopover.bind(this)})}this._oColorPalettePopoverMinDefautButton.openBy(t)},_onSelectColorInColorPalettePopover:function e(n){var t=this.getView().getModel("editedPollinationModel");t.setProperty("/label_color_rgb",n.getParameter("value"));t.updateBindings(false)},onChangeInputCalcGerminationRate:function e(n){this.onChangeInputPreventNonInt(n);var t=this.getView().getModel("editedPollinationModel");var o=t.getProperty("/first_seeds_sown");var i=t.getProperty("/first_seeds_germinated");if(o&&i){var l=i/o*100;var a=Math.round(l);t.setProperty("/germination_rate",a)}t.updateBindings(false)},onPressSubmitEditPollinationAndFinish:function n(t){e.confirm("Finish Pollination? This will remove it from the list and cannot be undone.",{onClose:this._onConfirmSubmitEditPollinationAndFinish.bind(this)})},_onConfirmSubmitEditPollinationAndFinish:function e(n){if(n==="OK"){this.onPressSubmitEditPollination(true)}else{}},onPressSubmitEditPollination:function e(n){var t=this.getView().getModel("editedPollinationModel");var o=t.getData();if(!o.pollination_timestamp_known){o.pollination_timestamp=undefined}if(!o.harvest_date_known){o.harvest_date=undefined}if(n===true){o.ongoing=false}var i=JSON.stringify(o);$.ajax({url:this.getServiceUrl("pollinations/"+o.id),data:i,context:this,async:true,type:"PUT",contentType:"application/json"}).done(this._onDonePutPollination).fail(this.onFail.bind(this,"Update pollination"))},_onDonePutPollination:function e(){this.applyToFragment("editPollination",e=>{e.close()});this._load_active_florescences();this._load_ongoing_pollinations()},onPressDeletePollination:function n(t){var o=this.getView().getModel("editedPollinationModel").getData().id;e.confirm("Really delete Pollination? This cannot be undone.",{onClose:this._onConfirmDeletePollination.bind(this,o)})},_onConfirmDeletePollination:function e(n,t){if(t==="OK"){this._deletePollination(n)}else{}},_deletePollination:function e(n){$.ajax({url:this.getServiceUrl("pollinations/"+n),context:this,async:true,type:"DELETE",contentType:"application/json"}).done(this._onDoneDeletePollination).fail(this.onFail.bind(this,"Delete pollination"))},_onDoneDeletePollination:function e(){this.applyToFragment("editPollination",e=>{e.close()});this._load_active_florescences();this._load_ongoing_pollinations()},onPressOpenPollenContainersMaintenance:function e(n){$.ajax({url:this.getServiceUrl("pollen_containers"),context:this,async:true,contentType:"application/json"}).done(this._onDoneGetPollenContainers).fail(this.onFail.bind(this,"Get pollen containers"));var t=this.getView();if(!this.byId("maintainPollenContainers")){s.load({name:"pollination.ui.view.fragments.MaintainPollenContainers",id:t.getId(),controller:this}).then(e=>{t.addDependent(e);e.open()})}else{this.byId("maintainPollenContainers").open()}},_onDoneGetPollenContainers:function e(t){var o=new n(t);o.setSizeLimit(2e3);this.getView().setModel(o,"pollenContainersModel")},onAfterClosemaintainPollenContainers:function e(n){var t=n.getSource();t.destroy();this.getView().getModel("pollenContainersModel").destroy()},onPressSubmitPollenContainers:function e(n){var t=this.getView().getModel("pollenContainersModel");var o=t.getData();var i={pollenContainerCollection:o.pollenContainerCollection};var l=JSON.stringify(i);$.ajax({url:this.getServiceUrl("pollen_containers"),data:l,context:this,async:true,type:"POST",contentType:"application/json"}).done(this._onDonePutPollenContainers).fail(this.onFail.bind(this,"Maintained Pollen Containers"))},_onDonePutPollenContainers:function e(){this.applyToFragment("maintainPollenContainers",e=>{e.close()},undefined);this._load_active_florescences()},onPressAddPlantForPollenContainer:function e(n){var t=this.byId("newPlantPollenContainerCount").getValue();if(t<=0){i.show("Please enter a positive number");return}var o=this.byId("newPlantPollenContainer");if(!o.getSelectedItem()){i.show("Please select a plant");return}var l=o.getSelectedItem().getBindingContext("pollenContainersModel").getObject();var a={plant_id:l.plant_id,plant_name:l.plant_name,genus:l.genus,count_stored_pollen_containers:t};var s=this.getView().getModel("pollenContainersModel");var r=s.getData().pollenContainerCollection;r.push(a);var c=s.getData().plantsWithoutPollenContainerCollection;var d=c.indexOf(l);c.splice(d,1);s.updateBindings(false);o.clearSelection()},onPressAddActiveFlorescence:function e(t){$.ajax({url:this.getServiceUrl("plants_for_new_florescence"),context:this,async:true,contentType:"application/json"}).done(this._onDoneGetPlantsForNewFlorescence).fail(this.onFail.bind(this,"Get plants for new florescence"));var o={plant_id:undefined,plant_name:undefined,florescence_status:"inflorescence_appeared",inflorescence_appearance_date:undefined,comment:undefined};var i=new n(o);this.getView().setModel(i,"newFlorescenceModel");var l=this.getView();if(!this.byId("addActiveFlorescence")){s.load({name:"pollination.ui.view.fragments.AddActiveFlorescence",id:l.getId(),controller:this}).then(e=>{l.addDependent(e);e.open()})}else{this.byId("addActiveFlorescence").open()}},_onDoneGetPlantsForNewFlorescence:function e(t){var o=new n(t.plantsForNewFlorescenceCollection);o.setSizeLimit(2e3);this.getView().setModel(o,"plantsForNewFlorescenceModel")},onPressSubmitNewFlorescence:function e(){var n=this.getView().getModel("newFlorescenceModel");var t=n.getData();var o=JSON.stringify(t);$.ajax({url:this.getServiceUrl("active_florescences"),data:o,context:this,async:true,type:"POST",contentType:"application/json"}).done(this._onDonePostNewFlorescence).fail(this.onFail.bind(this,"Create new florescence"))},_onDonePostNewFlorescence:function e(){this.applyToFragment("addActiveFlorescence",e=>{e.close()},undefined);this._load_active_florescences()},onAfterCloseAddActiveFlorescence:function e(n){var t=n.getSource();t.destroy();this.getView().getModel("plantsForNewFlorescenceModel").destroy();this.getView().getModel("newFlorescenceModel").destroy()},onPressRetrainProbabilityModelPollinationToSeed:function e(n){$.ajax({url:this.getServiceUrl("retrain_probability_pollination_to_seed_model"),context:this,async:true,type:"POST",contentType:"application/json"}).done(this._onDoneRetrainPollinationModel).fail(this.onFail.bind(this,"Retrain Pollination Model"))},_onDoneRetrainPollinationModel:function e(n){var t=this._oSuccessMessageDialog;if(!this._oSuccessMessageDialog){this._oSuccessMessageDialog=new r({type:v.Message,title:"Success",state:M.Success,content:new f({text:"Trained Model: "+n.model+"\n"+"Mean F1 Score: "+n.mean_f1_score}),beginButton:new _({type:m.Emphasized,text:"OK",press(){t.close()}})})}this._oSuccessMessageDialog.open()}});return C});